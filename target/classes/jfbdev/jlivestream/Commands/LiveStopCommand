package jfbdev.jlivestream.commands;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Sound;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;
import org.jetbrains.annotations.NotNull;

import java.util.List;

public class LiveStopCommand implements CommandExecutor {

    private final JavaPlugin plugin;
    public LiveStopCommand(JavaPlugin plugin) {
        this.plugin = plugin;
    }

    @Deprecated
    @Override
    public boolean onCommand(@NotNull CommandSender commandSender, @NotNull Command command, @NotNull String s, @NotNull String[] args) {

        String prefix = ChatColor.translateAlternateColorCodes('&', plugin.getConfig().getString("prefix", ""));

        String soundName = plugin.getConfig().getString("sound-end.name", "BLOCK_ANVIL_DESTROY");
        float volume = (float) plugin.getConfig().getDouble("sound-end.volume", 1.0);
        float pitch = (float) plugin.getConfig().getDouble("sound-end.pitch", 1.5);

        if (!(commandSender instanceof Player player)) {
            commandSender.sendMessage(ChatColor.translateAlternateColorCodes('&', prefix + plugin.getConfig().getString("messages.only-players", "")));
            return true;
        }

        if (!player.hasPermission("jlivestream.stop")) {
            player.sendMessage(ChatColor.translateAlternateColorCodes('&', prefix + plugin.getConfig().getString("messages.no-permission", "")));
            return true;
        }

        if (!player.hasPermission("jlivestream.online")) {
            player.sendMessage(ChatColor.translateAlternateColorCodes('&', prefix + plugin.getConfig().getString("messages.not-live", "")));
            return true;
        }

        if (args.length != 0) {
            player.sendMessage(ChatColor.translateAlternateColorCodes('&', prefix + plugin.getConfig().getString("messages.livestop-usage", "")));
            return true;
        }

        List<String> stopLines = plugin.getConfig().getStringList("broadcast.live.stopped");
        for (String line : stopLines) {
            String formatted = ChatColor.translateAlternateColorCodes('&',
                    line.replace("%player%", player.getName()));
            plugin.getServer().broadcastMessage(formatted);
        }
        player.sendMessage(ChatColor.translateAlternateColorCodes('&', prefix + plugin.getConfig().getString("messages.live-stopped", "")));

        Bukkit.dispatchCommand(Bukkit.getConsoleSender(), "lp user " + player.getName() + " permission unset jlivestream.online");

        Sound sound = Sound.valueOf(soundName.toUpperCase());
        for (Player online : Bukkit.getOnlinePlayers()) {
            online.playSound(online.getLocation(), sound, volume, pitch);
            return true;
        }
        return true;
    }
}
